#!/bin/sh
if [ -z "$CRM_alert_version" ]; then
  echo "$0 must be run by Pacemaker version 1.1.15 or later"
  exit 0
fi

# exit if isn't a rabbitmq alert or is not a monitor task
[ "$CRM_alert_kind" = "resource" -a "$CRM_alert_rsc" = "rabbitmq" -a "$CRM_alert_task" = "monitor" ] || exit 0

# launch the blocker in exclusive mode
nohup sudo flock /var/lock/rabbit /usr/bin/rabbitmq-port-blocker.sh &

# for each node in the cluster
<% @nodes.each do |cluster_node| -%>
  # unless this is the current node launch remotely the blocker in exclusive mode
  <% unless cluster_node.name==@node.name -%>
    nohup /usr/bin/timeout 15 sudo /usr/bin/ssh -o TCPKeepAlive=no -o ServerAliveInterval=15 root@<%= cluster_node.name %> nohup flock /var/lock/rabbit /usr/bin/rabbitmq-port-blocker.sh &
  <% end -%>
<% end -%>
